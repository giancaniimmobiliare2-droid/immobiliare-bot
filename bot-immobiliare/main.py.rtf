import os
import json
import gspread
import requests
import uuid
from oauth2client.service_account import ServiceAccountCredentials
from jinja2 import Environment, FileSystemLoader

# --- CONFIGURAZIONE ---
# Recuperiamo i segreti dalle variabili d'ambiente di GitHub
CREDS_JSON = os.environ["GOOGLE_CREDENTIALS"]
TELEGRAM_TOKEN = os.environ["TELEGRAM_TOKEN"]
NOME_FOGLIO_GOOGLE = "Gestionale Immobiliare" # <-- CAMBIA SE HAI CHIAMATO IL FILE DIVERSAMENTE

# --- FUNZIONI ---
def invia_telegram(chat_id, messaggio):
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    data = {"chat_id": chat_id, "text": messaggio}
    requests.post(url, data=data)

def genera_pagine():
    # 1. Autenticazione Google
    scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
    creds_dict = json.loads(CREDS_JSON)
    creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
    client = gspread.authorize(creds)

    # 2. Leggi Dati
    sheet = client.open(NOME_FOGLIO_GOOGLE)
    clienti = sheet.worksheet("Clienti").get_all_records()
    immobili = sheet.worksheet("Immobili").get_all_records()

    # 3. Prepara cartella output
    output_dir = "public"
    if not os.path.exists(output_dir):
        os.makedirs(output_dir)

    # 4. Prepara Template
    env = Environment(loader=FileSystemLoader('.'))
    template = env.get_template('template.html')

    # 5. Ciclo sui Clienti
    repo_name = os.environ.get("GITHUB_REPOSITORY") # es: tuonome/immobiliare-bot
    # URL base di GitHub Pages: https://tuonome.github.io/immobiliare-bot/
    base_url = f"https://{repo_name.split('/')[0]}.github.io/{repo_name.split('/')[1]}"

    for cliente in clienti:
        nome = cliente['Nome']
        telegram_id = str(cliente['TelegramID'])

        # Genera nome file segreto (es. rossi_a1b2.html)
        token_segreto = str(uuid.uuid4())[:8]
        nome_file = f"{nome.replace(' ', '_').lower()}_{token_segreto}.html"
        
        # Crea HTML
        html_content = template.render(nome_cliente=nome, immobili=immobili)
        
        # Salva file nella cartella 'public'
        with open(f"{output_dir}/{nome_file}", "w", encoding="utf-8") as f:
            f.write(html_content)
        
        # Invia Link Telegram
        link_finale = f"{base_url}/{nome_file}"
        messaggio = f"Ciao {nome}! ðŸ \nEcco le proposte di questo mese selezionate per te:\n{link_finale}"
        
        try:
            invia_telegram(telegram_id, messaggio)
            print(f"âœ… Inviato a {nome}: {link_finale}")
        except Exception as e:
            print(f"âŒ Errore invio a {nome}: {e}")

if __name__ == "__main__":
    genera_pagine()